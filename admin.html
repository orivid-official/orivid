<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORIVID Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f5f2;
            color: #1A232E;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #CBA135;
            box-shadow: 0 0 0 2px rgba(203, 161, 53, 0.5);
        }
        /* Style untuk modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .category-nav-btn.active {
            background-color: #1A232E;
            color: white;
        }
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <!-- Header Admin Panel -->
    <header class="bg-[#1A232E] text-[#f7f5f2] p-4 shadow-md flex justify-between items-center">
        <div class="flex items-center">
            <h1 class="text-2xl md:text-3xl font-bold">ORIVID Admin</h1>
            <span class="ml-4 text-sm md:text-base">Panel Pengelolaan</span>
        </div>
        <button id="logoutBtn" class="bg-[#CBA135] text-[#1A232E] font-semibold py-2 px-4 rounded-md hover:bg-[#a9882a] transition-colors">
            Logout
        </button>
    </header>

    <!-- Navigasi Utama -->
    <nav class="bg-[#333] p-4 shadow-md">
        <div class="flex justify-center space-x-4">
            <button id="navProducts" class="nav-item text-[#f7f5f2] font-semibold py-2 px-4 rounded-md transition-colors bg-[#CBA135] text-[#1A232E]">
                Kelola Produk
            </button>
            <button id="navUsers" class="nav-item text-[#f7f5f2] font-semibold py-2 px-4 rounded-md hover:bg-[#a9882a] transition-colors">
                Kelola User
            </button>
        </div>
    </nav>

    <main class="flex-grow w-full max-w-7xl mx-auto p-4 md:p-8">
        <h2 class="text-3xl font-bold mb-6 text-center text-[#1A232E]">Dashboard Admin</h2>

        <!-- Tampilan ID Pengguna untuk kolaborasi -->
        <div id="userIdDisplay" class="text-center text-sm text-gray-500 mb-4"></div>

        <!-- Bagian Loading -->
        <div id="loading" class="text-center text-gray-500 hidden">
            <p>Memuat data...</p>
        </div>

        <!-- Bagian Pengelolaan Produk -->
        <section id="productSection" class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h3 class="text-2xl font-bold mb-4 border-b-2 border-[#CBA135] pb-2 text-[#333]">Kelola Produk</h3>
            
            <!-- Formulir Tambah Produk -->
            <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div>
                    <label for="name" class="block text-sm font-medium mb-1 text-[#333]">Nama Produk</label>
                    <input type="text" id="name" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="category" class="block text-sm font-medium mb-1 text-[#333]">Kategori</label>
                    <select id="category" required class="w-full border rounded-md p-2 text-[#333]">
                        <option value="tshirt">T-Shirt</option>
                        <option value="polo">Polo</option>
                        <option value="hoodie">Hoodie</option>
                        <option value="jacket">Jacket</option>
                        <option value="pants">Celana</option>
                        <option value="accessories">Aksesoris</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="image" class="block text-sm font-medium mb-1 text-[#333]">URL Gambar</label>
                    <input type="url" id="image" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium mb-1 text-[#333]">Deskripsi Produk</label>
                    <textarea id="description" rows="4" class="w-full border rounded-md p-2 text-[#333]" required></textarea>
                </div>
                <div>
                    <label for="price" class="block text-sm font-medium mb-1 text-[#333]">Harga (contoh: Rp150.000)</label>
                    <input type="text" id="price" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="oldPrice" class="block text-sm font-medium mb-1 text-[#333]">Harga Awal (Opsional)</label>
                    <input type="text" id="oldPrice" class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="rating" class="block text-sm font-medium mb-1 text-[#333]">Rating (1.0 - 5.0)</label>
                    <input type="number" id="rating" min="1" max="5" step="0.1" value="5.0" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-[#1A232E] text-white font-semibold py-2 rounded-md hover:bg-[#CBA135] hover:text-black transition-colors">
                        Tambahkan Produk
                    </button>
                </div>
            </form>

            <!-- Navigasi Kategori Produk -->
            <div class="flex flex-wrap gap-2 mb-4 justify-center">
                <button class="category-nav-btn py-2 px-4 rounded-md transition-colors font-semibold text-sm bg-gray-200 hover:bg-gray-300 active" data-category="all">Semua</button>
                <button class="category-nav-btn py-2 px-4 rounded-md transition-colors font-semibold text-sm bg-gray-200 hover:bg-gray-300" data-category="tshirt">T-Shirt</button>
                <button class="category-nav-btn py-2 px-4 rounded-md transition-colors font-semibold text-sm bg-gray-200 hover:bg-gray-300" data-category="polo">Polo</button>
                <button class="category-nav-btn py-2 px-4 rounded-md transition-colors font-semibold text-sm bg-gray-200 hover:bg-gray-300" data-category="hoodie">Hoodie</button>
                <button class="category-nav-btn py-2 px-4 rounded-md transition-colors font-semibold text-sm bg-gray-200 hover:bg-gray-300" data-category="jacket">Jacket</button>
                <button class="category-nav-btn py-2 px-4 rounded-md transition-colors font-semibold text-sm bg-gray-200 hover:bg-gray-300" data-category="pants">Celana</button>
                <button class="category-nav-btn py-2 px-4 rounded-md transition-colors font-semibold text-sm bg-gray-200 hover:bg-gray-300" data-category="accessories">Aksesoris</button>
            </div>
            
            <!-- Fitur Pencarian dan Pengurutan -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="search" id="productSearch" placeholder="Cari produk..." class="w-full md:w-1/2 border rounded-md p-2 text-[#333]">
                <select id="productSort" class="w-full md:w-1/2 border rounded-md p-2 text-[#333]">
                    <option value="latest">Urutkan: Terbaru</option>
                    <option value="oldest">Urutkan: Terlama</option>
                </select>
            </div>
            
            <!-- Daftar Produk -->
            <div id="productList" class="space-y-4">
                <!-- Produk akan dimuat di sini oleh JavaScript -->
            </div>
        </section>

        <!-- Bagian Pengelolaan User -->
        <section id="userSection" class="bg-white p-6 rounded-lg shadow-lg hidden">
            <h3 class="text-2xl font-bold mb-4 border-b-2 border-[#CBA135] pb-2 text-[#333]">Kelola User</h3>
             <!-- Formulir Tambah User (opsional, sebagai contoh) -->
            <form id="addUserForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div>
                    <label for="user-name" class="block text-sm font-medium mb-1 text-[#333]">Nama User</label>
                    <input type="text" id="user-name" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="user-email" class="block text-sm font-medium mb-1 text-[#333]">Email</label>
                    <input type="email" id="user-email" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="user-phone" class="block text-sm font-medium mb-1 text-[#333]">Nomor HP</label>
                    <input type="tel" id="user-phone" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div class="md:col-span-2 mt-4">
                    <button type="submit" class="w-full bg-[#1A232E] text-white font-semibold py-2 rounded-md hover:bg-[#CBA135] hover:text-black transition-colors">
                        Tambahkan User
                    </button>
                </div>
            </form>

            <!-- Fitur Pencarian dan Pengurutan -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="search" id="userSearch" placeholder="Cari user..." class="w-full md:w-1/2 border rounded-md p-2 text-[#333]">
                <select id="userSort" class="w-full md:w-1/2 border rounded-md p-2 text-[#333]">
                    <option value="latest">Urutkan: Terbaru</option>
                    <option value="oldest">Urutkan: Terlama</option>
                </select>
            </div>

            <!-- Daftar User -->
            <div id="userList" class="space-y-4">
                <!-- User akan dimuat di sini oleh JavaScript -->
            </div>
        </section>
    </main>

    <!-- Modal Edit Produk (Tersembunyi secara default) -->
    <div id="editProductModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 border-b-2 border-[#CBA135] pb-2 text-[#333]">Edit Produk</h3>
            <form id="editProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="edit-product-doc-id">
                <div>
                    <label for="edit-name" class="block text-sm font-medium mb-1 text-[#333]">Nama Produk</label>
                    <input type="text" id="edit-name" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="edit-category" class="block text-sm font-medium mb-1 text-[#333]">Kategori</label>
                    <select id="edit-category" required class="w-full border rounded-md p-2 text-[#333]">
                        <option value="tshirt">T-Shirt</option>
                        <option value="polo">Polo</option>
                        <option value="hoodie">Hoodie</option>
                        <option value="jacket">Jacket</option>
                        <option value="pants">Celana</option>
                        <option value="accessories">Aksesoris</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="edit-image" class="block text-sm font-medium mb-1 text-[#333]">URL Gambar</label>
                    <input type="url" id="edit-image" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div class="md:col-span-2">
                    <label for="edit-description" class="block text-sm font-medium mb-1 text-[#333]">Deskripsi Produk</label>
                    <textarea id="edit-description" rows="4" class="w-full border rounded-md p-2 text-[#333]" required></textarea>
                </div>
                <div>
                    <label for="edit-price" class="block text-sm font-medium mb-1 text-[#333]">Harga</label>
                    <input type="text" id="edit-price" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="edit-oldPrice" class="block text-sm font-medium mb-1 text-[#333]">Harga Awal (Opsional)</label>
                    <input type="text" id="edit-oldPrice" class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="edit-rating" class="block text-sm font-medium mb-1 text-[#333]">Rating (1.0 - 5.0)</label>
                    <input type="number" id="edit-rating" min="1" max="5" step="0.1" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancelEditProduct" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600 transition-colors">Batal</button>
                    <button type="submit" class="bg-[#CBA135] text-[#1A232E] font-semibold py-2 px-4 rounded-md hover:bg-[#a9882a] transition-colors">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Edit User (Tersembunyi secara default) -->
    <div id="editUserModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 border-b-2 border-[#CBA135] pb-2 text-[#333]">Edit User</h3>
            <form id="editUserForm" class="grid grid-cols-1 gap-4">
                <input type="hidden" id="edit-user-doc-id">
                <div>
                    <label for="edit-user-name" class="block text-sm font-medium mb-1 text-[#333]">Nama User</label>
                    <input type="text" id="edit-user-name" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="edit-user-email" class="block text-sm font-medium mb-1 text-[#333]">Email</label>
                    <input type="email" id="edit-user-email" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div>
                    <label for="edit-user-phone" class="block text-sm font-medium mb-1 text-[#333]">Nomor HP</label>
                    <input type="tel" id="edit-user-phone" required class="w-full border rounded-md p-2 text-[#333]">
                </div>
                <div class="flex justify-end space-x-4 mt-4">
                    <button type="button" id="cancelEditUser" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-gray-600 transition-colors">Batal</button>
                    <button type="submit" class="bg-[#CBA135] text-[#1A232E] font-semibold py-2 px-4 rounded-md hover:bg-[#a9882a] transition-colors">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let products = [];
        let users = [];
        let activeCategory = 'all';

        const productListEl = document.getElementById('productList');
        const userListEl = document.getElementById('userList');
        const loadingEl = document.getElementById('loading');
        const userIdDisplayEl = document.getElementById('userIdDisplay');

        // Fungsi untuk format tanggal menjadi string yang mudah dibaca
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // Fungsi untuk merender daftar produk
        function renderProductList() {
            productListEl.innerHTML = '';
            
            const searchQuery = document.getElementById('productSearch').value.toLowerCase();
            const sortOrder = document.getElementById('productSort').value;

            let filteredProducts = products;
            if (activeCategory !== 'all') {
                filteredProducts = products.filter(p => p.category === activeCategory);
            }

            filteredProducts = filteredProducts.filter(product =>
                product.name.toLowerCase().includes(searchQuery) ||
                (product.description && product.description.toLowerCase().includes(searchQuery))
            );

            // Sort data in memory
            filteredProducts.sort((a, b) => {
                const dateA = new Date(a.date_updated);
                const dateB = new Date(b.date_updated);
                if (sortOrder === 'latest') {
                    return dateB - dateA;
                } else {
                    return dateA - dateB;
                }
            });

            if (filteredProducts.length === 0) {
                productListEl.innerHTML = `<p class="text-center text-gray-500">Tidak ada produk yang ditemukan.</p>`;
                return;
            }

            const groupedProducts = filteredProducts.reduce((acc, product) => {
                const category = product.category;
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(product);
                return acc;
            }, {});

            Object.keys(groupedProducts).forEach(category => {
                if (activeCategory === 'all') {
                    const categoryTitle = document.createElement('h4');
                    categoryTitle.className = 'text-lg font-bold mt-6 mb-2 capitalize text-[#333]';
                    categoryTitle.textContent = category.replace(/-/g, ' ');
                    productListEl.appendChild(categoryTitle);
                }

                groupedProducts[category].forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'flex flex-col md:flex-row items-center justify-between p-4 bg-gray-50 rounded-md shadow-sm border border-gray-200';
                    productCard.innerHTML = `
                        <div class="flex-shrink-0 mb-4 md:mb-0">
                            <img src="${product.image}" alt="${product.name}" class="w-20 h-20 object-cover rounded-md" onerror="this.src='https://placehold.co/80x80?text=Error'">
                        </div>
                        <div class="flex-1 flex flex-col w-full md:w-auto md:ml-4 gap-2">
                            <div class="flex items-center justify-between w-full">
                                <h4 class="font-semibold text-base">${product.name}</h4>
                                <div class="flex items-baseline space-x-2">
                                    ${product.oldPrice ? `<p class="text-sm text-gray-400 line-through">${product.oldPrice}</p>` : ''}
                                    <p class="text-sm font-bold text-gray-800">${product.price}</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600">${product.description ? product.description.substring(0, 100) : ''}...</p>
                            <div class="flex justify-between items-center mt-2">
                                <p class="text-sm text-gray-600">Rating: ${product.rating}</p>
                                <div class="text-xs text-gray-400">
                                    <p>Diperbarui: ${product.date_updated ? formatDate(product.date_updated) : 'N/A'}</p>
                                    <p>Dibuat: ${product.date_created ? formatDate(product.date_created) : 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-4 md:mt-0">
                            <button class="edit-product-btn bg-blue-500 text-white text-sm font-semibold px-4 py-2 rounded-md hover:bg-blue-600 transition-colors" data-doc-id="${product.id}">
                                Edit
                            </button>
                            <button class="delete-product-btn bg-red-500 text-white text-sm font-semibold px-4 py-2 rounded-md hover:bg-red-600 transition-colors" data-doc-id="${product.id}">
                                Hapus
                            </button>
                        </div>
                    `;
                    productListEl.appendChild(productCard);
                });
            });
        }

        // Fungsi untuk merender daftar user
        function renderUserList() {
            userListEl.innerHTML = '';
            
            const searchQuery = document.getElementById('userSearch').value.toLowerCase();
            const sortOrder = document.getElementById('userSort').value;

            let filteredUsers = users.filter(user =>
                user.name.toLowerCase().includes(searchQuery) ||
                user.email.toLowerCase().includes(searchQuery) ||
                user.phone.toLowerCase().includes(searchQuery)
            );

            // Sort data in memory
            filteredUsers.sort((a, b) => {
                const dateA = new Date(a.date_created);
                const dateB = new Date(b.date_created);
                if (sortOrder === 'latest') {
                    return dateB - dateA;
                    } else {
                    return dateA - dateB;
                }
            });

            if (filteredUsers.length === 0) {
                userListEl.innerHTML = `<p class="text-center text-gray-500">Tidak ada user yang ditemukan.</p>`;
                return;
            }

            filteredUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'flex flex-col md:flex-row items-center justify-between p-4 bg-gray-50 rounded-md shadow-sm border border-gray-200';
                userCard.innerHTML = `
                    <div class="flex-1 w-full md:w-auto">
                        <h4 class="font-semibold text-base">${user.name}</h4>
                        <p class="text-sm text-gray-600">${user.email}</p>
                        <p class="text-sm text-gray-600">No HP: ${user.phone}</p>
                        <p class="text-xs text-gray-400">Dibuat: ${user.date_created ? formatDate(user.date_created) : 'N/A'} | Diperbarui: ${user.date_updated ? formatDate(user.date_updated) : 'N/A'}</p>
                    </div>
                    <div class="flex space-x-2 mt-2 md:mt-0">
                        <button class="edit-user-btn bg-blue-500 text-white text-sm font-semibold px-4 py-2 rounded-md hover:bg-blue-600 transition-colors" data-doc-id="${user.id}">
                            Edit
                        </button>
                        <button class="delete-user-btn bg-red-500 text-white text-sm font-semibold px-4 py-2 rounded-md hover:bg-red-600 transition-colors" data-doc-id="${user.id}">
                            Hapus
                        </button>
                    </div>
                `;
                userListEl.appendChild(userCard);
            });
        }

        // Fungsi untuk menambahkan data contoh jika database kosong
        async function addInitialData() {
            const productRef = collection(db, `artifacts/${appId}/public/data/products`);
            const productSnapshot = await getDocs(productRef);
            if (productSnapshot.empty) {
                const initialProducts = [
                    { name: "Kaos Klasik Putih", description: "Kaos polos yang nyaman dan serbaguna, cocok untuk semua gaya.", category: "tshirt", image: "https://placehold.co/250x200/cccccc/000000?text=T-Shirt+1", price: "Rp150.000", oldPrice: "Rp200.000", rating: 4.5, date_created: new Date().toISOString(), date_updated: new Date().toISOString() },
                    { name: "Polo Shirt Biru", description: "Polo shirt berwarna biru cerah dengan kerah yang rapi, ideal untuk acara kasual.", category: "polo", image: "https://placehold.co/250x200/cccccc/000000?text=Polo+1", price: "Rp210.000", oldPrice: "Rp280.000", rating: 4.0, date_created: new Date().toISOString(), date_updated: new Date().toISOString() },
                    { name: "Hoodie Abu-abu", description: "Hoodie tebal yang nyaman dengan bahan flecee, cocok untuk cuaca dingin.", category: "hoodie", image: "https://placehold.co/250x200/cccccc/000000?text=Hoodie+1", price: "Rp350.000", oldPrice: null, rating: 5.0, date_created: new Date().toISOString(), date_updated: new Date().toISOString() },
                ];
                for (const product of initialProducts) {
                    await addDoc(productRef, product);
                }
            }

            const userRef = collection(db, `artifacts/${appId}/users/${userId}/users`);
            const userSnapshot = await getDocs(userRef);
            if (userSnapshot.empty) {
                 const initialUsers = [
                    { name: "Admin ORIVID", email: "orivid325@gmail.com", phone: "081234567890", date_created: new Date().toISOString(), date_updated: new Date().toISOString() },
                    { name: "Joko Susilo", email: "joko.s@gmail.com", phone: "085678901234", date_created: new Date().toISOString(), date_updated: new Date().toISOString() },
                ];
                for (const user of initialUsers) {
                    await addDoc(userRef, user);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi Firebase
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } else {
                console.error("Firebase config is missing.");
                loadingEl.innerHTML = `<p class="text-center text-red-500">Firebase tidak dapat diinisialisasi. Silakan periksa konfigurasi.</p>`;
                return;
            }

            // Atur loading state
            loadingEl.classList.remove('hidden');

            // Autentikasi dan mulai mendengarkan perubahan
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplayEl.textContent = `User ID: ${userId}`;
                    
                    // Tambahkan data contoh jika kosong
                    await addInitialData();
                    
                    // Atur listener real-time untuk produk
                    const productRef = collection(db, `artifacts/${appId}/public/data/products`);
                    onSnapshot(productRef, (snapshot) => {
                        products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderProductList();
                        loadingEl.classList.add('hidden');
                    });

                    // Atur listener real-time untuk user
                    const userRef = collection(db, `artifacts/${appId}/users/${userId}/users`);
                    onSnapshot(userRef, (snapshot) => {
                        users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderUserList();
                        loadingEl.classList.add('hidden');
                    });

                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        loadingEl.innerHTML = `<p class="text-center text-red-500">Gagal melakukan autentikasi: ${error.message}</p>`;
                    }
                }
            });

            // Handler untuk tombol Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                window.location.href = 'https://orivid-official.github.io/orivid/';
            });
            
            // Event listener untuk input pencarian produk
            document.getElementById('productSearch').addEventListener('input', renderProductList);
            
            // Event listener untuk dropdown sort produk
            document.getElementById('productSort').addEventListener('change', renderProductList);

            // Event listener untuk input pencarian user
            document.getElementById('userSearch').addEventListener('input', renderUserList);
            
            // Event listener untuk dropdown sort user
            document.getElementById('userSort').addEventListener('change', renderUserList);

            // Fungsionalitas Tambah Produk
            document.getElementById('addProductForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newProduct = {
                    name: document.getElementById('name').value,
                    image: document.getElementById('image').value,
                    description: document.getElementById('description').value,
                    category: document.getElementById('category').value,
                    price: document.getElementById('price').value,
                    oldPrice: document.getElementById('oldPrice').value || null,
                    rating: parseFloat(document.getElementById('rating').value),
                    date_created: new Date().toISOString(),
                    date_updated: new Date().toISOString()
                };

                try {
                    const productRef = collection(db, `artifacts/${appId}/public/data/products`);
                    await addDoc(productRef, newProduct);
                    document.getElementById('addProductForm').reset();
                    console.log('Produk baru berhasil ditambahkan.');
                } catch (e) {
                    console.error("Error adding document: ", e);
                }
            });

            // Fungsionalitas Edit Produk
            document.getElementById('productList').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-product-btn')) {
                    const docId = e.target.dataset.docId;
                    const productToEdit = products.find(p => p.id === docId);

                    if (productToEdit) {
                        document.getElementById('edit-product-doc-id').value = productToEdit.id;
                        document.getElementById('edit-name').value = productToEdit.name;
                        document.getElementById('edit-image').value = productToEdit.image;
                        document.getElementById('edit-description').value = productToEdit.description;
                        document.getElementById('edit-category').value = productToEdit.category;
                        document.getElementById('edit-price').value = productToEdit.price;
                        document.getElementById('edit-oldPrice').value = productToEdit.oldPrice || '';
                        document.getElementById('edit-rating').value = productToEdit.rating;
                        
                        document.getElementById('editProductModal').classList.remove('hidden');
                    }
                }
            });

            // Fungsionalitas Simpan Perubahan Produk
            document.getElementById('editProductForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const docId = document.getElementById('edit-product-doc-id').value;
                const updatedProductData = {
                    name: document.getElementById('edit-name').value,
                    image: document.getElementById('edit-image').value,
                    description: document.getElementById('edit-description').value,
                    category: document.getElementById('edit-category').value,
                    price: document.getElementById('edit-price').value,
                    oldPrice: document.getElementById('edit-oldPrice').value || null,
                    rating: parseFloat(document.getElementById('edit-rating').value),
                    date_updated: new Date().toISOString()
                };

                try {
                    const productRef = doc(db, `artifacts/${appId}/public/data/products`, docId);
                    await updateDoc(productRef, updatedProductData);
                    document.getElementById('editProductModal').classList.add('hidden');
                    console.log(`Produk berhasil diperbarui: ${docId}`);
                } catch (e) {
                    console.error("Error updating document: ", e);
                }
            });

            // Fungsionalitas Tambah User
            document.getElementById('addUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const newUser = {
                    name: document.getElementById('user-name').value,
                    email: document.getElementById('user-email').value,
                    phone: document.getElementById('user-phone').value,
                    date_created: new Date().toISOString(),
                    date_updated: new Date().toISOString()
                };

                try {
                    const userRef = collection(db, `artifacts/${appId}/users/${userId}/users`);
                    await addDoc(userRef, newUser);
                    document.getElementById('addUserForm').reset();
                    console.log('User baru berhasil ditambahkan.');
                } catch (e) {
                    console.error("Error adding user: ", e);
                }
            });

            // Fungsionalitas Edit User
            document.getElementById('userList').addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-user-btn')) {
                    const docId = e.target.dataset.docId;
                    const userToEdit = users.find(u => u.id === docId);

                    if (userToEdit) {
                        document.getElementById('edit-user-doc-id').value = userToEdit.id;
                        document.getElementById('edit-user-name').value = userToEdit.name;
                        document.getElementById('edit-user-email').value = userToEdit.email;
                        document.getElementById('edit-user-phone').value = userToEdit.phone;
                        
                        document.getElementById('editUserModal').classList.remove('hidden');
                    }
                }
            });

            // Fungsionalitas Simpan Perubahan User
            document.getElementById('editUserForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const docId = document.getElementById('edit-user-doc-id').value;
                const updatedUserData = {
                    name: document.getElementById('edit-user-name').value,
                    email: document.getElementById('edit-user-email').value,
                    phone: document.getElementById('edit-user-phone').value,
                    date_updated: new Date().toISOString()
                };

                try {
                    const userRef = doc(db, `artifacts/${appId}/users/${userId}/users`, docId);
                    await updateDoc(userRef, updatedUserData);
                    document.getElementById('editUserModal').classList.add('hidden');
                    console.log(`User berhasil diperbarui: ${docId}`);
                } catch (e) {
                    console.error("Error updating user: ", e);
                }
            });
            
            // Tombol Batal untuk Modal
            document.getElementById('cancelEditProduct').addEventListener('click', () => {
                document.getElementById('editProductModal').classList.add('hidden');
            });

            document.getElementById('cancelEditUser').addEventListener('click', () => {
                document.getElementById('editUserModal').classList.add('hidden');
            });
            
            // Event listener untuk tombol Hapus Produk
            document.getElementById('productList').addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-product-btn')) {
                    const docId = e.target.dataset.docId;
                    try {
                        const productRef = doc(db, `artifacts/${appId}/public/data/products`, docId);
                        await deleteDoc(productRef);
                        console.log(`Produk berhasil dihapus: ${docId}`);
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                }
            });

            // Event listener untuk tombol Hapus User
            document.getElementById('userList').addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-user-btn')) {
                    const docId = e.target.dataset.docId;
                    try {
                        const userRef = doc(db, `artifacts/${appId}/users/${userId}/users`, docId);
                        await deleteDoc(userRef);
                        console.log(`User berhasil dihapus: ${docId}`);
                    } catch (e) {
                        console.error("Error deleting user: ", e);
                    }
                }
            });
            
            // Fungsionalitas navigasi
            const navProductsBtn = document.getElementById('navProducts');
            const navUsersBtn = document.getElementById('navUsers');
            const productSection = document.getElementById('productSection');
            const userSection = document.getElementById('userSection');

            function showSection(sectionToShow, sectionToHide, activeBtn, inactiveBtn) {
                sectionToShow.classList.remove('hidden');
                sectionToHide.classList.add('hidden');
                
                activeBtn.classList.add('bg-[#CBA135]', 'text-[#1A232E]');
                activeBtn.classList.remove('hover:bg-[#a9882a]');
                
                inactiveBtn.classList.remove('bg-[#CBA135]', 'text-[#1A232E]');
                inactiveBtn.classList.add('hover:bg-[#a9882a]');
            }

            navProductsBtn.addEventListener('click', () => {
                showSection(productSection, userSection, navProductsBtn, navUsersBtn);
            });

            navUsersBtn.addEventListener('click', () => {
                showSection(userSection, productSection, navUsersBtn, navProductsBtn);
            });
            
            // Event listener untuk navigasi kategori produk
            document.querySelectorAll('.category-nav-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    activeCategory = e.target.dataset.category;
                    
                    document.querySelectorAll('.category-nav-btn').forEach(btn => btn.classList.remove('active'));
                    
                    e.target.classList.add('active');
                    
                    renderProductList();
                });
            });
        });
    </script>
</body>
</html>
