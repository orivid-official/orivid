<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORIVID Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f5f2;
            color: #333;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #CBA135;
            box-shadow: 0 0 0 2px rgba(203, 161, 53, 0.5);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header -->
    <header class="bg-[#1A232E] text-white p-4 text-center relative">
        <h1 class="text-3xl font-bold">ORIVID Admin Panel</h1>
        <!-- Logout Button -->
        <button id="logoutBtn" class="absolute top-4 right-4 bg-red-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-red-600 transition-colors">
            Logout
        </button>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <!-- Add New Product Section -->
        <section class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-[#CBA135] pb-2">Tambah Produk Baru</h2>
            <form id="addProductForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="name_id" class="block text-sm font-medium mb-1">Nama Produk (ID)</label>
                    <input type="text" id="name_id" required class="w-full border rounded-md p-2">
                </div>
                <div>
                    <label for="name_en" class="block text-sm font-medium mb-1">Nama Produk (EN)</label>
                    <input type="text" id="name_en" required class="w-full border rounded-md p-2">
                </div>
                <div class="md:col-span-2">
                    <label for="image" class="block text-sm font-medium mb-1">URL Gambar</label>
                    <input type="url" id="image" required class="w-full border rounded-md p-2">
                </div>
                <div>
                    <label for="category" class="block text-sm font-medium mb-1">Kategori</label>
                    <select id="category" required class="w-full border rounded-md p-2">
                        <option value="tshirt">T-Shirt</option>
                        <option value="polo">Polo</option>
                        <option value="hoodie">Hoodie</option>
                        <option value="jacket">Jacket</option>
                        <option value="pants">Celana</option>
                        <option value="accessories">Aksesoris</option>
                    </select>
                </div>
                <div>
                    <label for="price" class="block text-sm font-medium mb-1">Harga (contoh: Rp150.000)</label>
                    <input type="text" id="price" required class="w-full border rounded-md p-2">
                </div>
                <div>
                    <label for="oldPrice" class="block text-sm font-medium mb-1">Harga Lama (Opsional)</label>
                    <input type="text" id="oldPrice" class="w-full border rounded-md p-2">
                </div>
                <div>
                    <label for="rating" class="block text-sm font-medium mb-1">Rating (1.0 - 5.0)</label>
                    <input type="number" id="rating" min="1" max="5" step="0.1" value="5.0" required class="w-full border rounded-md p-2">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-[#1A232E] text-white font-semibold py-2 rounded-md hover:bg-[#CBA135] hover:text-black transition-colors">
                        Tambahkan Produk
                    </button>
                </div>
            </form>
        </section>

        <!-- Product List Section -->
        <section class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-[#CBA135] pb-2">Daftar Produk</h2>
            <div id="productList" class="space-y-4">
                <p>Memuat produk...</p>
            </div>
        </section>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment. DO NOT change these.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let productsCollectionRef;

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                const userId = auth.currentUser ? auth.currentUser.uid : 'anonymous';
                // Use a secure path for this app's data
                productsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/products`);

                console.log("Firebase initialized and user signed in. User ID:", userId);

                // Set up real-time listener for the products
                setupRealtimeListener();

                // Add event listener for logout button
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    auth.signOut().then(() => {
                        console.log("User signed out. Reloading page...");
                        window.location.reload();
                    });
                });

            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                document.getElementById('productList').innerHTML = `<p class="text-red-500">Gagal terhubung ke database. Silakan coba lagi nanti.</p>`;
            }
        }

        /**
         * Sets up a real-time listener for the products collection.
         * Renders the product list whenever data changes.
         */
        function setupRealtimeListener() {
            onSnapshot(productsCollectionRef, (snapshot) => {
                const products = [];
                snapshot.forEach(doc => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                renderProductList(products);
                console.log("Product list updated from Firestore.");
            }, (error) => {
                console.error("Error fetching documents: ", error);
                document.getElementById('productList').innerHTML = `<p class="text-red-500">Gagal memuat produk. Terjadi kesalahan.</p>`;
            });
        }

        /**
         * Renders the product list on the page.
         * @param {Array<Object>} products - The array of product objects to render.
         */
        function renderProductList(products) {
            const productListElement = document.getElementById('productList');
            productListElement.innerHTML = '';
            
            if (products.length === 0) {
                productListElement.innerHTML = `<p class="text-gray-500">Belum ada produk yang ditambahkan.</p>`;
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-md shadow-sm border border-gray-200';
                productCard.innerHTML = `
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg">${product.name_id}</h3>
                        <p class="text-sm text-gray-600">${product.price}</p>
                    </div>
                    <button class="delete-btn bg-red-500 text-white text-sm font-semibold px-4 py-2 rounded-md hover:bg-red-600 transition-colors" data-id="${product.id}">
                        Hapus
                    </button>
                `;
                productListElement.appendChild(productCard);
            });
        }

        // Handler untuk submit form "Tambah Produk"
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get form data
            const newProduct = {
                name_id: document.getElementById('name_id').value,
                name_en: document.getElementById('name_en').value,
                image: document.getElementById('image').value,
                category: document.getElementById('category').value,
                price: document.getElementById('price').value,
                oldPrice: document.getElementById('oldPrice').value || null,
                rating: parseFloat(document.getElementById('rating').value),
                createdAt: new Date() // Add a timestamp
            };
            
            try {
                // Add the new product to Firestore
                await addDoc(productsCollectionRef, newProduct);
                console.log('Produk berhasil ditambahkan ke Firestore.');
                document.getElementById('addProductForm').reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                // In a real app, you would show a user-friendly error message here
            }
        });

        // Event listener for delete buttons, using event delegation
        document.getElementById('productList').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const productId = e.target.dataset.id;
                
                try {
                    // Delete the product from Firestore
                    await deleteDoc(doc(db, productsCollectionRef.path, productId));
                    console.log(`Produk dengan ID ${productId} berhasil dihapus.`);
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    // In a real app, you would show a user-friendly error message
                }
            }
        });

        // Initialize the app on page load
        initializeFirebase();
    </script>
</body>
</html>
